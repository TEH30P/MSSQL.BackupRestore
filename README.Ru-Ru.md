---
language: powershell
module: MSSQL.BackupRestore
module file: MSSQL.BackupRestore.psm1
---
# Модуль `MSSQL.BackupRestore`
Автоматизация процесса резервного копирования и восстановления БД MSSQL.

Параметры: 
- \#0 - : **`!обяз`**, `[Version]` - версия сборки "`Microsoft.SqlServer.Smo`". по-умолчанию будет выбрана последняя версия.

## Команда `New-MSSQLBkpRepo` (`~MSSQLBR~BkpRepo~Init`)
Создаёт дерево папок репозитория бекапов.
- `qeue` - очередь бекапов/ресторов. Может быть UTF8 текстовым файлом в котором должен быть записан полный путь альтернативного хранилища состояния очереди бекапов.
    - `new` - бекапы, ждущие очереди
    - `act` - активные бекапы
    - `fin` - завершенные бекапы
    - `err` - бекапы которые были завершены с ошибкой
    - `wrn` - бекапы которые были завершены, но с не критическими ошибками
- `data` - бекапы данных (full/diff/...)
    - `<fs-sqlsrv-name>` - (создаётся при первом бекапе) папка с бекапами определённого экземпляра SQL
        - `<fs-sqldb-name>` - (создаётся при первом бекапе) папка с бекапами определённой БД
- `tlog` - бекапы логов транзакций (структура подпапок аналогична `data`)

Параметры: 
- \#0 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам репозиториев бекапов.

Результат:
- *`!ошибка!`* : путь к корневой папке репозитория не найден.

## Команда `New-MSSQLBkpFileName` (`~MSSQLBR~BkpFile~Name~Gen`)
Вернёт имя файла(ов) бекапа которое у них должно быть в репозитории `$iaRepoPath`. Использует `$iSrvInst` чтоб запросом "`RESTORE HEADERONLY FROM`" прочитать заголовок бекапа. Используется для интеграции бекапов сделанных не этим модулем или деактивированных бекапов.

**!ВАЖНО!**: файлы `$iaBkpFilePath` должны быть ОДНИМ бекапом, т.е. передача массива файлов нескольких бекапов (сделанных в разное время, с разных баз данных и т.п.) вызовет ошибку.

Результат: 
- `[string[]]` : имя файла с путём.
- *`!ошибка!`* : исходный файл не найден или не удалось прочитать заголовок бекапа.

Параметры: 
- \#0 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
- \#1 `iSrvInst` : **`обяз`**, `[Object]` - Строка с именем экземпляра целевого MSSQL сервера или объект `[Microsoft.SqlServer.Management.Smo.Server]`.
- \#2 `iaBkpFilePath` : **`обяз`**, `[string[]]` - Полный путь к файлам бекапа БД MSSQL.
- \#3 `iRepoIdx` : **`!обяз`**, `[int]` - Если в `$iaBkpFilePath` передан массив длиной более 1, то будет возвращено имя конечное имя файла с индексом указанным сдесь.

## Команда `Select-MSSQLBkpFile` (`~MSSQLBR~BkpRepo~Search`)
Поиск бекапа в репозитории. Результат отсортирован по возрастанию даты, а затем по имени репозитория.

Результат: 
- `[psobject[]]` : объект с описанием бекапа файла: путь, дата окончания, тип бекапа и т.п.
- *`!ошибка!`* : путь к репозиторию не найден; или нет такой БД в репозитории.

Параметры: 
- \#0 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
- \#1 `iFltSrvInst` : **`!обяз`**, `[string]` - Фильтр поиска: имя экземпляра MSSQL.
- \#2 `iFltDBName` : **`!обяз`**, `[string]` - Фильтр поиска: имя БД.
-  `fDBData` : **`обяз`**, `[switch]` - Если указан, то поиск бекапов данных: full/diff.
-  `fFltDiff` : **`!обяз`**, `[switch]` - Если указан, то поиск разностных бекапов.
-  `fTLog` : **`!обяз`**, `[switch]` - Если указан, то поиск бекапов лога транзакций.
-  `iFltAtMin` : **`!обяз`**, `[datetime]` - Нижняя граница диапазона дат (`-lt`).
-  `iFltAtMax` : **`!обяз`**, `[datetime]` - Верхняя граница диапазона дат (`-gt`).
-  `iFltCopyOnly` : **`!обяз`**, `[bool]` - Фильтр поиска: только `COPY_ONLY` бекапы.
-  `iFltLast` : **`!обяз`**, `[int]` - Объём возвращаемого результата. При этом реальное число возвращённых файлов бекапов будет равно `$iaRepoPath.Count * $iFltLast`.

## Команда `Backup-MSSQLDBData` (`~MSSQLBR~DBDataBkp~Do`)
Простой бекап данных full или diff.

Результат:
- *`!ошибка!`* : нет такого SQL сервера или БД.

Параметры: 
- \#0 `iSrvInst` : **`обяз`**, `[Object]` - Строка с именем экземпляра целевого MSSQL сервера или объект `[Microsoft.SqlServer.Management.Smo.Server]`.
- \#1 `iDBName` : **`обяз`**, `[string]` - Имя БД MSSQL.
- \#2 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
-  `fCompression` : **`!обяз`**, `[switch]` - Включить сжатие бекапа (`BACKUP ... WITH COMPRESSION`). **УСТАРЕВШИЙ**: параметр будет убран из будущих версий, в данный момент по-умолчанию "включен".
-  `fCopyOnly` : **`!обяз`**, `[switch]` - Выполнять бекап с атрибутом "*только копия*" (`BACKUP ... WITH COPY_ONLY`).
-  `fDiff` : **`!обяз`**, `[switch]` - Сделать разностный бекап (`BACKUP DATABASE ... WITH DIFFERENTIAL`).
-  `fRemoveDB` : **`!обяз`**, `[switch]` - После бекапа планируется выводить БД из эксплуатации или удалять. Если передан, то база будет переведена в режим "*только чтение*" (`ALTER DATABASE ... SET READ_ONLY`) непосредственно перед началом резервного копирования.
-  `iArcLayer` : **`!обяз`**, `[byte]` - Архивный слой (см. Примечания).
-  `iPriority` : **`!обяз`**, `[byte]` - Приоритет в очереди (см. Примечания).
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.
-  `iConfPath` : **`!обяз`**, `[string]` - Путь к файлу конфигурации, если есть.

## Команда `Import-MSSQLDBDataBkpConf` (`~MSSQLBR~DBDataBkpSmart~Conf~Load`)
Загрузка цепочки конфигурационных файлов. Для работы команды требуется загрузить модуль `JobShedule.Utils`.
Подробнее см. Примечания.

Результат:
- `[hashtable]`: "`splatting`" параметры командлета `Invoke-MSSQLDBDataBkp` (`~MSSQLBR~DBDataBkpSmart~Do`)
- *`!ошибка!`* : один из файлов в цепочки конфигураций не найден.

Параметры: 
- \#0.A `iConf` ( `ConfObj`, `O` ): **`обяз`**, `[psobject]` - Объект с информацией о конфигурации аналогичный `JobShedule.Utils` `[NPSShJob.CConfData]`.
- \#0.B `iaPath` ( `Path`, `P` ): **`обяз`**, `[string[]]` - Путь к файлу конфигурации.
- \#1.B `iPathDef` ( `PathDef`, `PD` ): **`!обяз`**, `[string]` - Путь к файлу конфигурации с настройками "по-умолчанию".
-  `fRaw` ( `Raw` ): **`!обяз`**, `[switch]` - Переключатель типа возвращаемого результата (для отладки). Если указан, то будет возвращён объект типа `JobShedule.Utils` `[NPSShJob.CConfData]`. 

## Команда `Backup-MSSQLDBDataSmart` (`~MSSQLBR~DBDataBkpSmart~Do`)
Интеллектуальный бекап данных (full/diff) "c азартными играми и женщинами с низкой социальной ответственностью".

Для решения о том какй бекап делаться система делает несколько проверок:
- Если в репозитории нет полного (`FULL`) не "только копия" (`COPY_ONLY`) бекапа, то будет выполнен полный бекап.
- Из заголовков последнего полного и разностного бекапа запрашивается размер бекапа без учёта компрессии (`RESTORE HEADERONLY ...` поле `[BackupSize]`).
  - `$FullSize` - размер полного бекапа.
  - `$DiffSize` - размер разностного бекапа, если он был после полного; иначе `$DiffSize = 0`.
- Проверяется условие `$DiffSize * $iDiffSizeFactor + $FullSize -ge $iTotalSizeMax`, если оно истинно то делается полный бекап.
- Проверяется условие `$DiffSize -ge $FullSize * $iDiffFullRatioMax`, если оно истинно то делается полный бекап.

После того как запущен бекап, условие `$DiffSize -ge $FullSize * $iDiffFullRatioMax` также проверяется, при том что `$DiffSize` это размер файла выполняемого бекапа. Если условие становится истинным, то выполнение бекапа отменяется и запускается полный бекап.

Описанные выше проверки не выполняются, если автоматический режим выключен: т.е. `$iOperAllow` равно "`d`" или "`f`".

После того как бекап сделан все описанные выше проверки выполняются вновь; но при положительных результатах проверок, делается только сообщение в лог и элемент очереди данного бекапа помечается как "с-не-критическими-ошибками" (`Wrn`). 

Также, после завершения разностного бекапа, проверяется целостность цепочки бекапов т.е. сравнивается значение соответствующих `LSN` полного и разностного бекапов. В автоматическом режиме, запускается полный бекап, а иначе делается только сообщение в лог и элемент очереди бекапа помечается как "с-не-критическими-ошибками" (`Wrn`).

В конце проверяется время, если продолжительность процесса резервного копированияе превысила `$iDuration`, то делается сообщение в лог и элемент очереди бекапа помечается как "с-не-критическими-ошибками" (`Wrn`). 

Результат:
- *`!ошибка!`* : нет такого SQL сервера или БД.
- *`!ошибка!`* : `$iDiffFullRatioMax`, `$iDiffSizeFactor` или `$iTotalSizeMax` меньше нуля.

Параметры: 
- \#0 `iSrvInst` : **`обяз`**, `[string]` - Имя экземпляра MSSQL.
- \#1 `iDBName` : **`обяз`**, `[string]` - Имя БД MSSQL.
- \#2 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
- \#3 `iStartAt` : **`обяз`**, `[datetime]` - Время начала бекапа (левая граница окна).
- \#4 `iDuration` : **`обяз`**, `[timespan]` - Продолжительность бекапа (ширина окна).
-  `fCompression` : **`!обяз`**, `[switch]` - Включить сжатие бекапа (`BACKUP ... WITH COMPRESSION`). **УСТАРЕВШИЙ**: параметр будет убран из будущих версий, в данный момент по-умолчанию "включен".
-  `iArcLayer` : **`!обяз`**, `[byte]` - Архивный слой (см. Примечания).
-  `iDiffFullRatioMax` : **`обяз`**, `[double]` - Параметр автоматического режима (см. Описание).
-  `iDiffSizeFactor` : **`обяз`**, `[double]` - Параметр автоматического режима (см. Описание).
-  `iTotalSizeMax` : **`!обяз`**, `[long]` - Параметр автоматического режима (см. Описание).
-  `iOperAllow` : **`!обяз`**, `[string]` - Допустимые операции. Включение/выключение автоматического режима. Значения:
   - "`f`" - только полные бекапы, 
   - "`d`" - только расностные бекапы,
   - "`df`", "`fd`", "" - без ограничений (автоматический режим).
-  `iPriority` : **`!обяз`**, `[byte]` - Приоритет в очереди (см. Примечания).
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.
-  `iConfPath` : **`!обяз`**, `[string]` - Путь к файлу конфигурации, если есть.

## Команда `Backup-MSSQLDBTLog` (`~MSSQLBR~TlogBkp~Do`)
Простой бекап лога транзакций.

Результат:
- *`!ошибка!`* : нет такого SQL сервера или БД, а также настройки БД не позволяют выполнять данный бекап.

Параметры: 
- \#0 `iSrvInst` : **`обяз`**, `[Object]` - Строка с именем экземпляра целевого MSSQL сервера или объект `[Microsoft.SqlServer.Management.Smo.Server]`.
- \#1 `iDBName` : **`обяз`**, `[string]` - Имя БД MSSQL.
- \#2 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
-  `fCompression` : **`!обяз`**, `[switch]` - Включить сжатие бекапа (`BACKUP ... WITH COMPRESSION`). **УСТАРЕВШИЙ**: параметр будет убран из будущих версий, в данный момент по-умолчанию "включен".
-  `fCopyOnly` : **`!обяз`**, `[switch]` - Выполнять бекап с атрибутом `COPY_ONLY` (`BACKUP ... WITH COPY_ONLY`).
-  `iPriority` : **`!обяз`**, `[byte]` - Приоритет в очереди (см. Примечания).
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.
-  `iConfPath` : **`!обяз`**, `[string]` - Путь к файлу конфигурации, если есть.

## Команда `Import-MSSQLDBTLogBkpConf` (`~MSSQLBR~TLogBkpSmart~Conf~Load`)
Загрузка цепочки конфигурационных файлов. Для работы команды требуется загрузить модуль `JobShedule.Utils`.
Подробнее (см. Примечания).

Результат:
- `[hashtable]`: "`splatting`" параметры командлета `Invoke-MSSQLDBTLogBkp` (`~MSSQLBR~TLogBkpSmart~Do`)
- *`!ошибка!`* : один из файлов в цепочки конфигураций не найден.

Параметры: 
- \#0 `iConf` ( `ConfObj`, `O` ): **`обяз`**, `[psobject]` - Объект с информацией о конфигурации аналогичный `JobShedule.Utils` `[NPSShJob.CConfData]`.
- \#0 `iaPath` ( `Path`, `P` ): **`обяз`**, `[string[]]` - Путь к файлу конфигурации.
- \#1 `iPathDef` ( `PathDef`, `PD` ): **`!обяз`**, `[string]` - Путь к файлу конфигурации с настройками "по-умолчанию".
-  `fRaw` ( `Raw` ): **`!обяз`**, `[switch]` - Переключатель типа возвращаемого результата (для отладки). Если указан, то будет возвращён объект типа `JobShedule.Utils` `[NPSShJob.CConfData]`. 

## Команда `Invoke-MSSQLDBTLogBkp` (`~MSSQLBR~TLogBkpSmart~Do`)
Непростой бекап лога транзакций.

Можно выделить два основных режима работы процесса "умного" резервного копирования лога транзакций: дневной и ночной. Также эти режимы можно комбинировать, или выполнять "классическое" простое резервное копирование лога транзакций.

"Классический" режим определяется параметром `$iAgeTrg`, который задаёт частоту снятия бекапов. В этом режиме система с периодом `$iAgeTrg` выполняет резервное копирование лога транзакций.

Использование параметров `$iAgeTrg`, `$iUsageMaxTrg` и `$iChkPeriod` задаёт дневной режим работы. В этом режиме с периодичностью `$iChkPeriod` система проверяет заполненность лога транзакций БД и время с последнего бекапа. Если объём занятого места в логе транзакций больше чем `$iUsageMaxTrg`, или если с момента последнего бекапа лога транзакций прошло времени больше чем `$iAgeTrg`: то выполняется резервное копирование лога транзакций. В этом режиме минимизируется вероятность прироста файла лога транзакций.

Использование параметров `$iAgeTrg`, `$iUsageMinTrg` и `$iChkPeriod` задаёт ночной режим работы. В этом режиме с периодичностью `$iChkPeriod` система проверяет заполненность лога транзакций БД и время с последнего бекапа. Если с момента последнего бекапа лога транзакций прошло времени больше чем `$iAgeTrg`, то проверяется объём занятого места в логе транзакций; а затем, если объём занятого места больше `$iUsageMinTrg`, то выполняется обычный бекап лога транзакций, а иначе бекап лога транзакций в режиме "только копия" (`COPY_ONLY`). В этом режиме, за счёт уменьшения количества файлов (т.к. все `COPY_ONLY` бекапы удаляются в последствии командой `Invoke-MSSQLBkpLangolier`), достигается небольшая экономия места, и ускорение процесса восстановления БД из лога транзакций (без увеличения времени отката).

Допустимо использовать и все четыре параметра: `$iAgeTrg`, `$iUsageMaxTrg`, `$iUsageMinTrg` и `$iChkPeriod`. Что применимо для БД с крайне малым количеством изменений, и отсутствием возможности переключить модель восстановления в "`SIMPLE`" (например при использовании "AllwaysOn", "Log Shipping" и т.п.).

Результат:
- *`!ошибка!`* : нет такого SQL сервера или БД.
- *`!ошибка!`* : несовместимость значений `$iChkPeriod` и `$iAgeTrg`: период `$iChkPeriod` должен быть меньше `$iAgeTrg`, и количество секунд в `$iAgeTrg` должно быть кратно количеству секунд в `$iChkPeriod`. Например `$iChkPeriod = '0.00:00:15'` не будет совместимо с `$iAgeTrg = '0.00:01:05'` т.к. `65` (`'0.00:01:05'`) не кратно `15` (`'0.00:00:15'`).
- *`!ошибка!`* : отсутствие параметра `$iChkPeriod`, при использовании `$iUsageMaxTrg` и/или `$iUsageMinTrg`.

Параметры: 
- \#0 `iSrvInst` : **`обяз`**, `[string]` - Имя экземпляра MSSQL.
- \#1 `iDBName` : **`обяз`**, `[string]` - Имя БД MSSQL.
- \#2 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
- \#3 `iStartAt` : **`обяз`**, `[datetime]` - Время начала бекапа (левая граница окна).
- \#4 `iDuration` : **`обяз`**, `[timespan]` - Время работы команды (ширина окна). Т.е. время работы цикла по проверке состояния лога транзакций и выполнению бекапов.
-  `fCompression` : **`!обяз`**, `[switch]` - Включить сжатие бекапа (`BACKUP ... WITH COMPRESSION`). **УСТАРЕВШИЙ**: параметр будет убран из будущих версий, в данный момент по-умолчанию "включен".
-  `iAgeTrg` : **`!обяз`**, `[timespan]` - Параметр автоматического режима (см. Описание).
-  `iChkPeriod` : **`!обяз`**, `[timespan]` - Параметр автоматического режима (см. Описание).
-  `iUsageMaxTrg` : **`!обяз`**, `[long]` - Параметр автоматического режима (см. Описание).
-  `iUsageMinTrg` : **`!обяз`**, `[long]` - Параметр автоматического режима (см. Описание).
-  `iPriority` : **`!обяз`**, `[byte]` - Приоритет в очереди (см. Примечания).
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.
-  `iConfPath` : **`!обяз`**, `[string]` - Путь к файлу конфигурации, если есть.

## Команда `New-MSSQLBRDBFileRelocRule` (`~MSSQLBR~DBFileReloc~New`)
Создаёт шаблон перемещения: массив из правил перемещения `[NMSSQL.MBkpRst.CDBFileReloc]`.

Объект `[NMSSQL.MBkpRst.CDBFileReloc]` содержит следующие свойства:
- `PathTmpl` : **`обяз`**, `[scriptblock]` - подскрипт powershell, формирующий целевой путь файла БД.
- `APhysNamePtrn` : **`!обяз`**, `[array]` - Фильтр, список шаблонов `-like` для физического имени файла БД.
- `ALogicNamePtrn` : **`!обяз`**, `[array]` - Фильтр, список шаблонов `-like` для логического имени файла БД.
- `DTypeRelStr` : **`!обяз`**, `[hashtable]` - Фильтр, словарь, ключами которого являются коды типов файлов БД. Коды соответствуют значениям поля `Type` из результата запроса `RESTORE FILELISTONLY`. При этом "полнотекстовый каталог" (код "`F`") объединён с "SQL Server файл данных" (код "`D`") для прямой совместимости с последними версиями MSSQL.
   - "`L`" - файл журнала Microsoft SQL Server
   - "`D`" - SQL Server файл данных, полнотекстовый каталог
   - "`S`" - файловый поток, FileTable или контейнер In-Memory OLTP

Подробнее см. Примечание.

Результат:
- `[NMSSQL.MBkpRst.CDBFileReloc]`: массив из правил перемещения.

Параметры: 
- \#0.A `iTmpl` ( `Tmpl`, `T` ): **`обяз`**, `[psobject]` - Соответствует `[NMSSQL.MBkpRst.CDBFileReloc]::PathTmpl`. Допустимы строка `[String]` или `[scriptblock]`.
- \#1.A `iaPhysName` ( `PhysName`, `PN` ): **`!обяз`**, `[string[]]` -  Соответствует `[NMSSQL.MBkpRst.CDBFileReloc]::APhysNamePtrn`.
- \#2.A `iaLogicName` ( `LogicName`, `LN` ): **`!обяз`**, `[string[]]` - Соответствует `[NMSSQL.MBkpRst.CDBFileReloc]::ALogicNamePtrn`.
- \#3.A `idTypeRel` ( `TypeRel`, `TR` ): **`!обяз`**, `[hashtable]` - Соответствует `[NMSSQL.MBkpRst.CDBFileReloc]::DTypeRelStr`.
- \#.B `iDataDir` ( `DataDir` ): **`обяз`**, `[string]` - Папка, куда должны перемещаться файлы данных, файловых потоков и т.д. (НЕ логи транзакций), восстанавливаемой БД.
- \#.B `iTLogDir` ( `TLogDir` ): **`!обяз`**, `[string]` - Папка, куда должны перемещаться файлы лога транзакций, восстанавливаемой БД. По-умолчанию используется значение `iDataDir`.
- \#.B `fAppendBkpDate` ( `AppendBkpDate` ): **`!обяз`**, `[switch]` - Добавляет к имени каждого файла дату создания резервной копии.
- \#.B `fAppendCurrDate` ( `AppendCurrDate` ): **`!обяз`**, `[switch]` - Добавляет к имени каждого файла дату восстановления.

## Команда `Test-MSSQLBRDBFileRelocRule` (`~MSSQLBR~DBFileReloc~Test`)
Тестирование правила восстановления. Пвторяет логику алгоритма формирования нового пути файла БД при применении шаблона восстановления. Применяется для отладки.

Результат:
- `[String]`: Результат применения шаблона восстановления.

Параметры: 
- \#0 `iSrvInstSrc` : **`!обяз`**, `[string]` - Имя экземпляра SQL Server.
- \#1 `iDBNameSrc` : **`!обяз`**, `[string]` - Имя БД SQL Server.
- \#2 `iDBName` : **`!обяз`**, `[string]` - Новое имя БД, данное при восстановлении.
- \#3 `iDBFilePName` : **`обяз`**, `[string]` - Физическое имя файла БД.
- \#4 `iDBFileLName` : **`!обяз`**, `[string]` - Логичекое имя файла БД.
- \#5 `iDBFileType` : **`!обяз`**, `[EDBFileType]` - Код типа файла БД.
- \#6 `iBkpAt` : **`!обяз`**, `[datetime]` - Дата когда была сделана резервная копия.
- \#7 `iNow` : **`!обяз`**, `[datetime]` - Дата восстановления.
- \#8 `iaDBFileReloc` : **`!обяз`**, `[psobject[]]` - Шаблон перемещения для теста.

## Команда `Invoke-MSSQLDBRst` (`~MSSQLBR~DBRstSmart~Do`)
Умное восстановление БД из резервной копии.

Выполняет поиск необходимых резервных копий БД в репозитории, накладывает шаблон перемещения и восстанавливает БД.

Параметры: 
- \#0 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
- \#1 `iSrvInstSrc` : **`обяз`**, `[string]` - Имя эземпляра SQL Server БД источника.
- \#2 `iDBNameSrc` : **`обяз`**, `[string]` - Имя БД источника.
- \#3 `iSrvInst` : **`обяз`**, `[Object]` - Строка с именем экземпляра целевого MSSQL сервера или объект `[Microsoft.SqlServer.Management.Smo.Server]`.
- \#4 `iDBName` : **`обяз`**, `[string]` - Имя БД MSSQL.
- \#5 `iTimeTrg` : **`!обяз`**, `[datetime]` - Целевая дата - временная метка состояния БД.
-  `fNoRecovery` : **`!обяз`**, `[switch]` - Восстановить БД "без отката" (`RESTORE DATABASE ... WITH NORECOVERY`).
-  `fPointInTime` : **`!обяз`**, `[switch]` - Восстановить БД с применением резервных копий логов транзакций на конкретное время (`RESTORE LOG ... WITH STOPAT = '...'`). При отсутствии этого "флага" база будет восстановлена из последнего бекапа сделанного до даты `$iTimeTrg`.
-  `fReplace` : **`!обяз`**, `[switch]` - Восстановить БД с перезаписью (`RESTORE DATABASE ... WITH REPLACE`).
-  `fStandby` : **`!обяз`**, `[switch]` - Восстановить БД с резервным файлом (`RESTORE DATABASE ... WITH STANDBY = ...`). Путь к резервному файлу будет сформирован из пути последнего файла лога транзакций, но с расширением "`.sdf`". После к резервному файлу будет применен шаблон перемещения, как к файлу без логического имени, с типом "лог транзакций".
-  `iOperAllow` : **`!обяз`**, `[string]` - Фильтр по типу резервных копий:
   - "", "`dfl`", "`fdl`", "`ldf`" - без ограничений;
   - "`df`", "`fd`" - только бекапы данных (полные и разностные);
   - "`fl`""`lf`" - только полные бекапы данных и логи транзакций;
   - "`f`" - только полные бекапы;
   - "`d`" - только разностные бекапы, требуется наличие БД в состоянии `RESTORING`;
   - "`dl`", "`ld`" - только разностные бекапы и бекапы лога транзакций, требуется наличие БД в состоянии `RESTORING`;
   - "`l`" - только бекапы лога транзакций, требуется наличие БД в состоянии `RESTORING`;
   - "`c`" - только `copy_only` бекапы данных (полные или разностные), будет выбран самый последний `copy_only` бекап.
-  `iPriority` : **`!обяз`**, `[byte]` - Приоритет в очереди (см. Примечания).
-  `iaDBFileReloc` : **`!обяз`**, `[psobject[]]` - Шаблон перемещения.
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.
-  `iConfPath` : **`!обяз`**, `[string]` - Путь к файлу конфигурации, если есть.

## Команда `Add-MSSQLBRDBSnapshot` (`~MSSQLBR~DBSnapshot~Create`)
Создание моментального снимка БД (database snapshot).

Создаёт моментальный снимок бд. Расположение файлов моментального снимка можно определять с помощью шаблона перемещения. По умолчанию каждому файлу моментального снимка присваивается имя с суффиксом в виде даты создания моментального снимка в формате: "`имя-файла-исходной-БД , "." , дата-создания-снимка , "." , расширение-файла-исходной-БД `". Имя БД моментального снимка генерируется в формате "`имя-исходной-бд , "_sh_" , дата-создания-снимка`".

Результат:
- *`!ошибка!`* : нет такого SQL сервера или БД.

Параметры: 
- \#0 `iSrvInst` : **`обяз`**, `[string]` - Имя экземпляра MSSQL.
- \#1 `iDBName` : **`обяз`**, `[string]` - Имя БД MSSQL.
-  `iaDBFileReloc` : **`!обяз`**, `[psobject[]]` - Шаблон перемещения.
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.
-  `iConfPath` : **`!обяз`**, `[string]` - Путь к файлу конфигурации, если есть.

## Команда `Remove-MSSQLBRDBSnapshot` (`~MSSQLBR~DBSnapshot~Delete`)
Удаление моментальных снимков БД (database snapshot).

Удаляет моментальные снимки БД сделанные, командой `Add-MSSQLBRDBSnapshot` (`~MSSQLBR~DBSnapshot~Create`). Удаляются все моментальные снимки БД, за исключением тех что были сделаны в период указанный в параметрах `iFirstAt` и `iLastAt`. Дата моментального снимка берётся из названия (см. `~MSSQLBR~DBSnapshot~Create`), если название снимка не соответствует формату, то он игнорируется (не удаляется).

Результат:
- *`!ошибка!`* : нет такого SQL сервера или БД.

Параметры: 
- \#0 `iSrvInst` : **`обяз`**, `[string]` - Имя экземпляра MSSQL.
- \#1 `iDBName` : **`обяз`**, `[string]` - Имя БД MSSQL.
- \#2 `iLastAt` : **`!обяз`**, `[datetime]` - Будут удалены снимки которые были сделаны до момента указанного в этом параметре. По-умолчанию `[DateTime]::MaxValue`.
- \#3 `iFirstAt` : **`!обяз`**, `[datetime]` - Будут удалены снимки которые были сделаны после момента указанного в этом параметре. По-умолчанию `[DateTime]::MaxValue`.
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.
-  `iConfPath` : **`!обяз`**, `[string]` - Путь к файлу конфигурации, если есть.

## Команда `Import-MSSQLBkpLangolierConf` (`~MSSQLBR~Langolier~Conf~Load`)
Загрузка цепочки конфигурационных файлов. Для работы команды требуется загрузить модуль `JobShedule.Utils`.
Подробнее (см. Примечания).

Результат:
- `[hashtable]`: "`splatting`" параметры командлета `~MSSQLBR~Langolier~Do`
- *`!ошибка!`* : один из файлов в цепочке конфигураций не найден.

Параметры:
- \#0.A `iConf` ( `ConfObj`, `O` ): **`обяз`**, `[psobject]` - Объект с информацией о конфигурации аналогичный `JobShedule.Utils` `[NPSShJob.CConfData]`.
- \#0.B `iaPath` ( `Path`, `P` ): **`обяз`**, `[string[]]` - Путь к файлу конфигурации.
- \#1.B `iPathDef` ( `PathDef`, `PD` ): **`!обяз`**, `[string]` - Путь к файлу конфигурации с настройками "по-умолчанию".
-  `fRaw` ( `Raw` ): **`!обяз`**, `[switch]` - Переключатель типа возвращаемого результата (для отладки). Если указан, то будет возвращён объект типа `JobShedule.Utils` `[NPSShJob.CConfData]`. 

## Команда `Invoke-MSSQLBkpLangolier` (`~MSSQLBR~Langolier~Do`)
Менеджер очистки - удаление "старых" файлов резервных копий.

Каждый бекап данных имеет атрибут "номер слоя", который влияет на последующий процесс удаления. Время хранения бекапов указывается для каждого слоя. Команда `Invoke-MSSQLBkpLangolier` удаляет все резервные копии данных и логов транзакций чей возраст больше чем `$iaDataRtn` или `$iTLogRtn` соответсвтенно, и только те резервные копии данных, у которых "номер слоя" меньше или равен индексу в массиве `$iaDataRtn`. Также учитывается связь между полными и разностными резервными копиями данных, а также между всеми резервными копиями данных и логов транзакций: удаляются только те файлы, у которых все связанные с ними файлы тоже должны быть удалены.

Параметры: 
- \#0 `iSrvInst` : **`обяз`**, `[string]` - Имя экземпляра MSSQL.
- \#1 `iDBName` : **`обяз`**, `[string]` - Имя БД MSSQL.
- \#2 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
-  `fKeepCopyOnly` : **`!обяз`**, `[switch]` - Если не указан, то все файлы резервных копий с атрибутом "только копия", кроме последнего, будут удалены не взирая на их возраст и значение `$iaDataRtn`. Иначе к указаным файлам будет применяться условия такие же как для файлов со слоем равным нулю.
-  `iTLogRtn` : **`обяз`**, `[timespan]` - Время хранения файлов резервных копий логов транзакций. При этом будут удалены файлы чей возраст старше самого старого файла данных найденного после метки времени полученной отниманием `$iTLogRtn` от текущего времени.
-  `iaDataRtn` : **`обяз`**, `[timespan[]]` - Время хранения файлов резервных копий данных. Массив, в котором индекс означает "номер слоя" (см. Примечания).
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.
-  `iConfPath` : **`!обяз`**, `[string]` - Путь к файлу конфигурации, если есть.

## Команда `Invoke-MSSQLBRQueueMtn` (`~MSSQLBR~QueueMtn~Do`)
Менеджер очереди бекапов и ресторов. Очистка от старых элементов и активация новых. Подробнее смотри Примечание.

Параметры: 
- \#0 `iaRepoPath` : **`обяз`**, `[uri[]]` - **СЕТЕВОЙ** (UNC) путь к одной или нескольким корневым папкам бекапов.
- \#1 `iMode` : **`обяз`**, `[string]` - Режим работы:
   - "`Activity`", "`A`" - активация новых элементов: перенос из `New` в `Act`;
   - "`History`", "`H`" - удаление старых элементов из `Err`, `Wrn` и `Fin`.
- \#2 `iRetention` : **`обяз`**, `[timespan]` - Время хранения элементов. Применимо только для режима `$iMode -eq 'H'`.
- \#3 `iActivedCntMax` : **`!обяз`**, `[int]` - Максимальное количество активных элементов. Применимо только для режима `$iMode -eq 'A'`.
-  `fAsShJob` : **`!обяз`**, `[switch]` - Флаг указывающий на то, что функция выполняется в рамках автоматического задания. При этом флаге требуется загрузить модуль `JobShedule.Utils`.

## Примеры

Резервное копирование БД `[dbasandbox-01].[dba_db]` в репозиторий `\\bkp-01\sql`, с включённым сжатием, полная и разностная копия;
~~~ powershell
Import-Module MSSQL.BackupRestore -ArgumentList '13.0.0.0';

Backup-MSSQLDBData `
    -iSrvInst 'dbasandbox-01' `
    -iDBName 'dba_db' `
    -iaRepoPath @('\\bkp-01\sql') `
    -fCompression `
;

Backup-MSSQLDBData `
    -iSrvInst 'dbasandbox-01' `
    -iDBName 'dba_db' `
    -iaRepoPath @('\\bkp-01\sql') `
    -fDiff `
    -fCompression `
;
~~~


Резервное копирование лога транзакций БД `[dbasandbox-01].[dba_db]` в репозиторий `\\bkp-01\sql`, с включённым сжатием;
~~~ powershell
Import-Module MSSQL.BackupRestore -ArgumentList '13.0.0.0';

Backup-MSSQLDBTLog `
    -iSrvInst 'dbasandbox-01' `
    -iDBName 'dba_db' `
    -iaRepoPath @('\\bkp-01\sql') `
    -fCompression
;
~~~


Восстановление самой последней резервной копии БД `[dbasandbox-01].[dba_db]` из репозитория `\\bkp-01\sql`, на сервер `[dba-01]` под именем `[dba_db+1]`. При этом не будут использоваться бекапы лога транзакций. Файлы БД будут помещены в папки: логи транзакций "`d:\db_tlog`", а остальные файлы в "`d:\db_rows`".
~~~ powershell
Import-Module MSSQL.BackupRestore -ArgumentList '13.0.0.0';

New-MSSQLBRDBFileRelocRule -iDataDir 'D:\DB_ROWS' -TLogDir 'D:\DB_TLOG' `
| Restore-MSSQLDBSmart `
    -iaRepoPath @('\\bkp-01\sql') `
    -iSrvInstSrc 'dbasandbox-01' `
    -iDBNameSrc 'dba_db' `
    -iSrvInst 'dba-01' `
    -iDBName 'dba_db+1' `
    -iOperAllow fd ;
~~~

## Примечание

См. [TP.md](TP.Ru-Ru.md).